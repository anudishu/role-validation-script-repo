#!/bin/bash
# Unified deployment script for all roles on RHEL 9 GCP VM
# This script can deploy all 14 easily installable roles
# Project: lyfedge-project

set -euo pipefail

# Configuration
PROJECT_ID="lyfedge-project"
VM_NAME="rhel9-roles-test"
ZONE="us-central1-a"
DISK_NAME="rhel9-roles-test-data-disk"
DISK_SIZE="2GB"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Default: deploy all roles
DEPLOY_ALL=true
DEPLOY_ORIGINAL=false
DEPLOY_NEW=false
SKIP_DISK=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --original-only)
            DEPLOY_ALL=false
            DEPLOY_ORIGINAL=true
            shift
            ;;
        --new-only)
            DEPLOY_ALL=false
            DEPLOY_NEW=true
            SKIP_DISK=false
            shift
            ;;
        --skip-disk)
            SKIP_DISK=true
            shift
            ;;
        --vm-name)
            VM_NAME="$2"
            shift 2
            ;;
        --zone)
            ZONE="$2"
            shift 2
            ;;
        --project)
            PROJECT_ID="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --original-only    Deploy only original 9 roles"
            echo "  --new-only         Deploy only new 5 roles"
            echo "  --skip-disk        Skip disk creation/attachment (for new roles)"
            echo "  --vm-name NAME     VM name (default: rhel9-roles-test)"
            echo "  --zone ZONE        GCP zone (default: us-central1-a)"
            echo "  --project ID       GCP project (default: lyfedge-project)"
            echo "  --help, -h         Show this help message"
            echo ""
            echo "Examples:"
            echo "  $0                          # Deploy all 14 roles"
            echo "  $0 --original-only          # Deploy only original 9 roles"
            echo "  $0 --new-only               # Deploy only new 5 roles"
            echo "  $0 --new-only --skip-disk  # Deploy new roles without disk"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Determine which roles to deploy
if [[ "$DEPLOY_ALL" == "true" ]]; then
    DEPLOY_ORIGINAL=true
    DEPLOY_NEW=true
fi

echo -e "${CYAN}=========================================="
echo "Role Deployment Script"
echo "==========================================${NC}"
echo ""
echo -e "${BLUE}Configuration:${NC}"
echo "  Project: ${PROJECT_ID}"
echo "  VM Name: ${VM_NAME}"
echo "  Zone: ${ZONE}"
echo ""
echo -e "${BLUE}Deployment Plan:${NC}"
if [[ "$DEPLOY_ORIGINAL" == "true" ]]; then
    echo "  ✅ Original 9 roles: install-metadata, install-pyhton-runtime, install-users-group,"
    echo "     install-selinux-firewalld, install-docker-config, install-kubectl,"
    echo "     install-nltk-data, install-ops-agent-logging, install-cleanup"
fi
if [[ "$DEPLOY_NEW" == "true" ]]; then
    echo "  ✅ New 5 roles: install-Home, install-home-dir, install-os-login,"
    echo "     install-disk, install-nfs-mount"
    if [[ "$SKIP_DISK" == "true" ]]; then
        echo "  ⚠️  Disk creation/attachment: SKIPPED"
    else
        echo "  ✅ Disk creation/attachment: ENABLED"
    fi
fi
echo ""

# Step 1: Create and attach disk (if deploying new roles and disk not skipped)
if [[ "$DEPLOY_NEW" == "true" ]] && [[ "$SKIP_DISK" == "false" ]]; then
    echo -e "${YELLOW}Step 1: Creating and attaching 2GB disk...${NC}"
    
    # Check if disk already exists
    if gcloud compute disks describe "$DISK_NAME" --zone="$ZONE" --project="$PROJECT_ID" &>/dev/null 2>&1; then
        echo "  Disk $DISK_NAME already exists"
        
        # Check if disk is attached
        if gcloud compute instances describe "$VM_NAME" --zone="$ZONE" --project="$PROJECT_ID" \
            --format="value(disks[].source)" 2>/dev/null | grep -q "$DISK_NAME" || true; then
            echo -e "  ${GREEN}✅ Disk is already attached to VM${NC}"
        else
            echo "  Attaching existing disk to VM..."
            if gcloud compute instances attach-disk "$VM_NAME" \
                --disk="$DISK_NAME" \
                --zone="$ZONE" \
                --project="$PROJECT_ID" 2>/dev/null; then
                echo -e "  ${GREEN}✅ Disk attached${NC}"
            else
                echo -e "  ${YELLOW}⚠️  Could not attach disk (may already be attached)${NC}"
            fi
        fi
    else
        echo "  Creating new disk: $DISK_NAME ($DISK_SIZE)..."
        if gcloud compute disks create "$DISK_NAME" \
            --size="$DISK_SIZE" \
            --zone="$ZONE" \
            --project="$PROJECT_ID" 2>/dev/null; then
            echo "  Attaching disk to VM..."
            if gcloud compute instances attach-disk "$VM_NAME" \
                --disk="$DISK_NAME" \
                --zone="$ZONE" \
                --project="$PROJECT_ID" 2>/dev/null; then
                echo -e "  ${GREEN}✅ Disk created and attached${NC}"
            else
                echo -e "  ${YELLOW}⚠️  Disk created but could not attach${NC}"
            fi
        else
            echo -e "  ${YELLOW}⚠️  Could not create disk (may already exist)${NC}"
        fi
    fi
    echo ""
fi

# Step 2: Copy installation script to VM
echo -e "${YELLOW}Step 2: Copying installation script to VM...${NC}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_SCRIPT="${SCRIPT_DIR}/install-new-roles.sh"

if [[ ! -f "$INSTALL_SCRIPT" ]]; then
    echo -e "${RED}❌ Installation script not found: $INSTALL_SCRIPT${NC}"
    exit 1
fi

if gcloud compute scp "$INSTALL_SCRIPT" "${VM_NAME}:~/install-new-roles.sh" \
    --zone="$ZONE" \
    --project="$PROJECT_ID" 2>/dev/null; then
    echo -e "${GREEN}✅ Installation script copied to VM${NC}"
else
    echo -e "${RED}❌ Failed to copy installation script${NC}"
    exit 1
fi
echo ""

# Step 3: Copy validation scripts to VM
echo -e "${YELLOW}Step 3: Copying validation scripts to VM...${NC}"
ROLES_DIR="${SCRIPT_DIR}/roles"

# Determine which validation scripts to copy
VALIDATION_ROLES=()
if [[ "$DEPLOY_ORIGINAL" == "true" ]]; then
    VALIDATION_ROLES+=(
        "install-metadata"
        "install-pyhton-runtime"
        "install-users-group"
        "install-selinux-firewalld"
        "install-docker-config"
        "install-kubectl"
        "install-nltk-data"
        "install-ops-agent-logging"
        "install-cleanup"
    )
fi
if [[ "$DEPLOY_NEW" == "true" ]]; then
    VALIDATION_ROLES+=(
        "install-Home"
        "install-home-dir"
        "install-os-login"
        "install-disk"
        "install-nfs-mount"
    )
fi

COPIED_COUNT=0
for role in "${VALIDATION_ROLES[@]}"; do
    VALIDATION_SCRIPT="${ROLES_DIR}/${role}/validation/validate.sh"
    if [[ -f "$VALIDATION_SCRIPT" ]]; then
        if gcloud compute scp "$VALIDATION_SCRIPT" "${VM_NAME}:/tmp/validate-${role}.sh" \
            --zone="$ZONE" \
            --project="$PROJECT_ID" 2>/dev/null; then
            COPIED_COUNT=$((COPIED_COUNT + 1))
        fi
    fi
done

echo -e "${GREEN}✅ Copied ${COPIED_COUNT} validation scripts to VM${NC}"
echo ""

# Step 4: Run installation script on VM
echo -e "${YELLOW}Step 4: Running installation script on VM...${NC}"
echo "This may take several minutes..."
echo ""

# Prepare installation command
INSTALL_CMD="chmod +x ~/install-new-roles.sh && ~/install-new-roles.sh"

# Add role selection flags if needed
if [[ "$DEPLOY_ORIGINAL" == "true" ]] && [[ "$DEPLOY_NEW" == "false" ]]; then
    INSTALL_CMD="$INSTALL_CMD --original-only"
elif [[ "$DEPLOY_ORIGINAL" == "false" ]] && [[ "$DEPLOY_NEW" == "true" ]]; then
    INSTALL_CMD="$INSTALL_CMD --new-only"
    if [[ "$SKIP_DISK" == "true" ]]; then
        INSTALL_CMD="$INSTALL_CMD --skip-disk"
    fi
fi

if gcloud compute ssh "$VM_NAME" \
    --zone="$ZONE" \
    --project="$PROJECT_ID" \
    --command="$INSTALL_CMD" 2>&1; then
    echo ""
    echo -e "${GREEN}=========================================="
    echo "✅ Installation Complete!"
    echo "==========================================${NC}"
else
    echo ""
    echo -e "${RED}=========================================="
    echo "❌ Installation Failed"
    echo "==========================================${NC}"
    echo "Check the output above for details."
    exit 1
fi

echo ""
echo -e "${CYAN}Next Steps:${NC}"
echo "  1. Validate installations:"
echo "     ./copy-validation-scripts.sh"
echo "     gcloud compute ssh $VM_NAME --zone=$ZONE --project=$PROJECT_ID \\"
echo "       --command=\"cd /tmp && bash Master_Script.sh\""
echo ""
echo "  2. Check installation logs on VM:"
echo "     gcloud compute ssh $VM_NAME --zone=$ZONE --project=$PROJECT_ID \\"
echo "       --command=\"ls -lt /tmp/*installation*.log | head -1\""
echo ""
